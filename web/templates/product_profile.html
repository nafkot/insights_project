{% extends "base.html" %}

{% block content %}
<div class="profile-header">
    <div style="max-width:1200px; margin:0 auto;">
        <h1 class="profile-title">{{ product.name }}</h1>
        <div class="profile-meta">
            {% if product.brand_name %}
                Brand: <a href="/brand/{{ product.brand_id }}" style="text-decoration:underline; font-weight:600;">{{ product.brand_name }}</a>
            {% endif %}
        </div>
    </div>
</div>

<div style="max-width:1200px; margin:0 auto; padding:0 20px;">

    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:30px; margin-bottom:40px;">
        <div style="background: linear-gradient(135deg, #fff 0%, #fff9fb 100%); border:1px solid #e1e4e8; padding:24px; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-family:var(--font-serif); color:var(--text-dark);">âœ¨ Market Intelligence</h3>
                <span style="font-size:11px; color:#999; background:#fff; padding:2px 8px; border-radius:10px; border:1px solid #eee;">AI Generated</span>
            </div>
            {% if marketing_brief %}
                <div style="font-size:14px; line-height:1.6; color:#444;">{{ marketing_brief | safe }}</div>
            {% else %}
                <p style="color:#999;">Gathering data...</p>
            {% endif %}
        </div>

        <div style="display:grid; grid-template-rows: 1fr 1fr; gap:15px;">
            <div class="insight-card">
                <span class="insight-label">Total Mentions</span>
                <div class="insight-value">{{ metrics.total_mentions }}</div>
            </div>
            <div class="insight-card">
                <span class="insight-label">Avg Sentiment</span>
                <div class="insight-value">{{ "%.0f"|format(metrics.avg_sentiment or 0) }}%</div>
            </div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-bottom:60px;">
        <div class="list-card">
            <h3>Mentions Over Time</h3>
            <canvas id="mentionsChart" height="200"></canvas>
        </div>
        <div class="list-card">
            <h3>Sentiment History</h3>
            <canvas id="sentimentChart" height="200"></canvas>
        </div>
    </div>

    <div class="mention-feed" style="margin:0;">
        <h3 style="font-family:var(--font-serif); border-bottom:1px solid #eee; padding-bottom:12px; margin-bottom:24px;">
            Discussion History
        </h3>

        {% if videos %}
            {% for v in videos %}
            <div class="mention-card">
                {% if v.thumbnail_url %}
                <a href="/video/{{ v.video_id }}"><img src="{{ v.thumbnail_url }}" alt="Thumb" class="mention-thumb"></a>
                {% else %}
                <div class="mention-thumb" style="display:flex;align-items:center;justify-content:center;color:#ccc;">No Image</div>
                {% endif %}

                <div class="mention-content">
                    <div class="mention-header">
                        <span>{{ v.upload_date[:10] }}</span>
                        <span>by <a href="/channel/{{ v.channel_id }}" style="font-weight:600;">{{ v.channel_name }}</a></span>
                    </div>

                    <a href="/video/{{ v.video_id }}" class="mention-title">{{ v.title }}</a>

                    <div style="margin-bottom:12px;">
                        {% if v.sentiment_score > 60 %}
                            <span class="sentiment-badge sent-pos">Positive</span>
                        {% elif v.sentiment_score < 40 %}
                            <span class="sentiment-badge sent-neg">Negative</span>
                        {% else %}
                            <span class="sentiment-badge sent-neu">Neutral</span>
                        {% endif %}
                    </div>

                    <div class="mention-snippet" style="border-left: 3px solid var(--primary-color);">
                        <strong style="color:var(--primary-color); font-size:11px; text-transform:uppercase; display:block; margin-bottom:4px;">
                            Discussion Context:
                        </strong>
                        <span style="font-style:normal; color:#444;">{{ v.display_summary }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center; color:#999;">No mentions found.</p>
        {% endif %}
    </div>

</div>

<script>
    const labels = {{ chart_labels | tojson }};
    const mentionsData = {{ chart_mentions | tojson }};
    const sentimentData = {{ chart_sentiment | tojson }};

    if(labels.length > 0) {
        new Chart(document.getElementById('mentionsChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Mentions', data: mentionsData, backgroundColor: 'rgba(212, 106, 126, 0.6)' }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        new Chart(document.getElementById('sentimentChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Sentiment', data: sentimentData, borderColor: '#4caf50', tension: 0.3, fill: true, backgroundColor: 'rgba(76, 175, 80, 0.1)' }]
            },
            options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
        });
    }
</script>
{% endblock %}
