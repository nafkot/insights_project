{% extends "base.html" %}

{% block content %}
<div class="profile-header">
    <div style="max-width:1200px; margin:0 auto;">
        <div style="font-size:12px; color:var(--primary-color); font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">Brand Profile</div>
        <h1 class="profile-title">{{ brand.name }}</h1>
        <div class="profile-meta">
            Category: {{ brand.category or "Beauty" }}
        </div>
    </div>
</div>

<div style="max-width:1200px; margin:0 auto; padding:0 20px;">
    
    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:30px; margin-bottom:40px;">
        
        <div style="background: linear-gradient(135deg, #fff 0%, #fff9fb 100%); border:1px solid #e1e4e8; padding:24px; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-family:var(--font-serif); color:var(--text-dark);">âœ¨ Brand Intelligence</h3>
                <span style="font-size:11px; color:#999; background:#fff; padding:2px 8px; border-radius:10px; border:1px solid #eee;">AI Generated</span>
            </div>
            
            {% if marketing_brief %}
                <div style="font-size:14px; line-height:1.6; color:#444;">{{ marketing_brief | safe }}</div>
                
		<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>

		{% if marketing_brief %}
                <div style="font-size:14px; line-height:1.6; color:#444;">{{ marketing_brief | safe }}</div>

                {% if marketing_brief_data and marketing_brief_data.word_cloud %}
                <div class="cloud-container" style="margin-top:20px; text-align:center;">
                    <h4 style="font-size:11px; text-transform:uppercase; letter-spacing:1px; color:#999; margin-bottom:15px;">
                        Common Associations
                    </h4>

                    <div id="canvas-container" style="width:100%; height:250px; position:relative;">
                        <canvas id="sentimentCloudCanvas" width="500" height="250"></canvas>
                    </div>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        // 1. Prepare Data from Python -> JS
                        const rawData = [
                            {% for tag in marketing_brief_data.word_cloud %}
                            {
                                text: "{{ tag.text }}",
                                weight: {{ tag.weight|default(1) }},
                                sentiment: "{{ tag.sentiment|lower }}"
                            },
                            {% endfor %}
                        ];

                        // 2. Define Color Map
                        const colorMap = {
                            'positive': '#1e8e3e', // Green
                            'negative': '#c5221f', // Red
                            'neutral':  '#5f6368'  // Gray
                        };

                        // 3. Format for WordCloud2: [[word, size], ...]
                        // We scale the size up (weight * 6) to make it visible
                        const list = rawData.map(item => [item.text, 12 + (item.weight * 7)]);

                        // 4. Color Callback (Matches word to sentiment)
                        function colorCallback(word, weight, fontSize, distance, theta) {
                            // Find the original data object for this word
                            const original = rawData.find(x => x.text === word);
                            if (original && colorMap[original.sentiment]) {
                                return colorMap[original.sentiment];
                            }
                            return '#5f6368'; // Default Gray
                        }

                        // 5. Render
                        const canvas = document.getElementById('sentimentCloudCanvas');
                        // Make canvas fill the container width
                        canvas.width = document.getElementById('canvas-container').offsetWidth;

                        WordCloud(canvas, {
                            list: list,
                            gridSize: 8,
                            weightFactor: 1,
                            fontFamily: 'Inter, sans-serif',
                            color: colorCallback,
                            rotateRatio: 0,        // 0 = all horizontal (easier to read)
                            backgroundColor: 'transparent',
                            shrinkToFit: true,
                            drawOutOfBound: false
                        });
                    });
                </script>
                {% endif %}

            {% else %}
                <p style="color:#999; font-style:italic;">Gathering brand data...</p>
            {% endif %}
            {% else %}
                <p style="color:#999; font-style:italic;">Gathering brand data...</p>
            {% endif %}
        </div>

        <div style="display:grid; grid-template-rows: 1fr 1fr; gap:15px;">
            <div class="insight-card" style="display:flex; flex-direction:column; justify-content:center;">
                <span class="insight-label">Brand Mentions</span>
                <div class="insight-value">{{ metrics.total_mentions }}</div>
                <small style="color:#999;">Across {{ metrics.unique_channels }} channels</small>
            </div>
            <div class="insight-card" style="display:flex; flex-direction:column; justify-content:center;">
                <span class="insight-label">Brand Sentiment</span>
                <div class="insight-value">{{ "%.0f"|format(metrics.avg_sentiment or 0) }}%</div>
                <small style="color:#999;">Top Creator: {{ top_creator['channel_name'] if top_creator else 'N/A' }}</small>
            </div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-bottom:60px;">
        <div class="list-card">
            <h3>Mentions Over Time</h3>
            <canvas id="mentionsChart" height="200"></canvas>
        </div>
        <div class="list-card">
            <h3>Sentiment History</h3>
            <canvas id="sentimentChart" height="200"></canvas>
        </div>
    </div>

    {% if top_products %}
    <div style="margin-bottom:60px;">
        <h3 style="font-family:var(--font-serif); border-bottom:1px solid #eee; padding-bottom:12px; margin-bottom:24px;">
            Trending Products
        </h3>
        <div class="insight-grid" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
            {% for p in top_products %}
            <a href="/product/{{ p.id }}" class="insight-card" style="text-decoration:none; text-align:left; transition: transform 0.2s;">
                <div style="font-weight:700; color:var(--text-dark); margin-bottom:5px;">{{ p.name }}</div>
                <div style="font-size:12px; color:#888; display:flex; justify-content:space-between;">
                    <span>{{ p.cnt }} mentions</span>
                    {% if p.cnt > 0 %}
                        <span style="color:var(--primary-color);">{{ "%.0f"|format(p.score) }}% +ve</span>
                    {% else %}
                        <span style="color:#ccc;">N/A</span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="mention-feed" style="margin:0;">
        <h3 style="font-family:var(--font-serif); border-bottom:1px solid #eee; padding-bottom:12px; margin-bottom:24px;">
            Discussion History
        </h3>

        {% if videos %}
            {% for v in videos %}
            <div class="mention-card">
                {% if v.thumbnail_url %}
                <a href="/video/{{ v.video_id }}"><img src="{{ v.thumbnail_url }}" alt="Thumb" class="mention-thumb"></a>
                {% else %}
                <div class="mention-thumb" style="display:flex;align-items:center;justify-content:center;color:#ccc;">No Image</div>
                {% endif %}

                <div class="mention-content">
                    <div class="mention-header">
                        <span>{{ v.upload_date[:10] }}</span>
                        <span>by <a href="/channel/{{ v.channel_id }}" style="font-weight:600;">{{ v.channel_name }}</a></span>
                    </div>

                    <a href="/video/{{ v.video_id }}" class="mention-title">{{ v.title }}</a>

                    <div style="margin-bottom:12px;">
                        {% if v.sentiment_score > 60 %}
                            <span class="sentiment-badge sent-pos">Positive</span>
                        {% elif v.sentiment_score < 40 %}
                            <span class="sentiment-badge sent-neg">Negative</span>
                        {% else %}
                            <span class="sentiment-badge sent-neu">Neutral</span>
                        {% endif %}
                    </div>

                    <div class="mention-snippet" style="border-left: 3px solid var(--primary-color);">
                        <strong style="color:var(--primary-color); font-size:11px; text-transform:uppercase; display:block; margin-bottom:4px;">
                            Brand Context:
                        </strong>
                        <span style="font-style:normal; color:#444;">{{ v.display_summary }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center; color:#999;">No mentions found.</p>
        {% endif %}
    </div>

</div>

<script>
    const labels = {{ chart_labels | tojson }};
    const mentionsData = {{ chart_mentions | tojson }};
    const sentimentData = {{ chart_sentiment | tojson }};

    if(labels.length > 0) {
        new Chart(document.getElementById('mentionsChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Brand Mentions', data: mentionsData, backgroundColor: 'rgba(212, 106, 126, 0.6)' }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        new Chart(document.getElementById('sentimentChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Avg Sentiment', data: sentimentData, borderColor: '#4caf50', tension: 0.3, fill: true, backgroundColor: 'rgba(76, 175, 80, 0.1)' }]
            },
            options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
        });
    }
</script>
{% endblock %}
